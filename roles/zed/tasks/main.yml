- name: setup zed
  when: enable_zed | default(false)
  block:
    - name: install zed
      flatpak:
        name:
          - dev.zed.Zed

    - name: Setup user bin dir
      file:
        path: "~/bin"
        state: directory
        mode: "u=rwx,go=rx"

    - name: Create a symbolic link for zed
      ansible.builtin.file:
        src: "/var/lib/flatpak/exports/bin/dev.zed.Zed"
        dest: "/home/{{ user }}/bin/zed"
        state: link

    - name: Create drop in dir for flatpak-system-helper
      become: true
      ansible.builtin.file:
        dest: "/etc/systemd/system/flatpak-system-helper.service.d"
        state: directory
        owner: root
        mode: "u=rwx,go=rx"

    - name: Limit resources of zed flatpak
      become: true
      copy:
        content: |
          [Service]
          MemoryAccounting=true
          MemoryHigh=5G
          MemoryMax=10G
        dest: /etc/systemd/system/flatpak-system-helper.service.d/resource-limits.conf
      register: zed_resource_limits_file

    - name: Reload daemons
      become: true
      when: zed_resource_limits_file.changed
      shell: systemctl daemon-reload
