- name: setup zed
  when: enable_zed | default(false)
  block:
    - name: zed print var
      debug:
        var: zed

    - name: set defaults for zed role
      set_fact:
        zed_defaults:
          enable_helm_support: false
          zed_config:
            {
              "auto_install_extensions":
                {
                  "docker-compose": true,
                  "dockerfile": true,
                  "yaml": true,
                  "html": true,
                },
              "autosave": { "after_delay": { "milliseconds": 100 } },
              "base_keymap": "JetBrains",
              "buffer_font_size": 16,
              "drag_and_drop_selection": { "enabled": false },
              "edit_predictions":
                {
                  "mode": "subtle",
                  "copilot":
                    {
                      "proxy": null,
                      "proxy_no_verify": null,
                      "enterprise_uri": null,
                    },
                  "enabled_in_text_threads": false,
                },
              "languages": { "YAML": { "format_on_save": "off" } },
              "show_edit_predictions": false,
              "telemetry": { "metrics": false, "diagnostics": false },
              "theme":
                { "mode": "system", "light": "One Dark", "dark": "One Dark" },
              "ui_font_size": 16,
            }

    - name: set facts for zed role
      set_fact:
        zed: "{{ zed_defaults | combine( (zed | default({})), recursive=true ) }}"
    - name: install zed
      flatpak:
        name:
          - dev.zed.Zed

    - name: Setup user bin dir
      file:
        path: "~/bin"
        state: directory
        mode: "u=rwx,go=rx"

    - name: Create a symbolic link for zed
      ansible.builtin.file:
        src: "/var/lib/flatpak/exports/bin/dev.zed.Zed"
        dest: "/home/{{ user }}/bin/zed"
        state: link

    - name: Create drop in dir for flatpak-system-helper
      become: true
      ansible.builtin.file:
        dest: "/etc/systemd/system/flatpak-system-helper.service.d"
        state: directory
        owner: root
        mode: "u=rwx,go=rx"

    - name: Limit resources of zed flatpak
      become: true
      copy:
        content: |
          [Service]
          MemoryAccounting=true
          MemoryHigh=5G
          MemoryMax=10G
        dest: /etc/systemd/system/flatpak-system-helper.service.d/resource-limits.conf
      register: zed_resource_limits_file

    - name: Reload daemons
      become: true
      when: zed_resource_limits_file.changed
      shell: systemctl daemon-reload

    - name: provision zed config
      copy:
        content: |
          {{ zed.zed_config | to_nice_json }}
        dest: "/home/{{ user }}/.var/app/dev.zed.Zed/config/zed/settings.json"
