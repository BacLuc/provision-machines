"""Unit tests for cleanup_node_modules.py"""

import os
import shutil
import time
from unittest.mock import patch

import cleanup_node_modules
import pytest


@pytest.fixture
def tmp_home(tmp_path):
    """Create a temporary directory tree with node_modules."""
    base = tmp_path / "home"
    base.mkdir()
    yield base
    shutil.rmtree(base)


def test_last_access_time(tmp_home):
    """Check that last_access_time returns a sane value."""
    foo = tmp_home / "foo"
    foo.mkdir()
    assert cleanup_node_modules.last_access_time(foo) <= time.time()


def test_human_size():
    assert cleanup_node_modules.human_size(512) == "512.0 B"
    assert cleanup_node_modules.human_size(2048) == "2.0 KB"


def test_collect_node_modules(tmp_home):
    """Create directories touched 30 days ago and verify collection."""
    old = tmp_home / "old"
    old.mkdir()
    nm = old / "node_modules"
    nm.mkdir()

    # touch everything 30 days ago
    old_epoch = time.time() - 30 * 24 * 3600
    os.utime(old, (old_epoch, old_epoch))
    os.utime(nm, (old_epoch, old_epoch))

    cutoff = time.time() - 21 * 24 * 3600
    found = list(cleanup_node_modules.collect_node_modules(tmp_home, cutoff))
    assert len(found) == 1
    assert found[0][0] == nm


def test_main_dry_run(capsys, tmp_home):
    """Dry-run should print but not delete."""
    old = tmp_home / "old"
    old.mkdir()
    nm = old / "node_modules"
    nm.mkdir()
    old_epoch = time.time() - 30 * 24 * 3600
    os.utime(old, (old_epoch, old_epoch))
    os.utime(nm, (old_epoch, old_epoch))

    with patch("sys.argv", ["cleanup_node_modules.py", "--dry-run", str(tmp_home)]):
        cleanup_node_modules.main()
    out, _ = capsys.readouterr()
    assert "[DRY-RUN]" in out
    assert nm.exists()


def test_main_delete(capsys, tmp_home):
    """Test delete"""
    old = tmp_home / "old"
    old.mkdir()
    nm = old / "node_modules"
    nm.mkdir()
    old_epoch = time.time() - 30 * 24 * 3600
    os.utime(old, (old_epoch, old_epoch))
    os.utime(nm, (old_epoch, old_epoch))

    with patch("sys.argv", ["cleanup_node_modules.py", str(tmp_home)]):
        cleanup_node_modules.main()
    capsys.readouterr()
    assert not nm.exists()
